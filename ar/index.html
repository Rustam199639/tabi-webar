<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>TABI Agent AR — Instrumented</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js" crossorigin="anonymous"></script>

  <!-- THREE shim so AR.js (older) works with A-Frame 1.4.x (r147) -->
  <script>
    (function fixThreeForARJS(){
      const tag='[BOOT]';
      function post(level,msg,obj){
        try{
          const line = `[${level}] ${tag} ${msg}${obj? ' ' + JSON.stringify(obj): ''}`;
          console.log(line);
          window.ReactNativeWebView?.postMessage(JSON.stringify({type:'console', level:'log', args:[line]}));
          pushLog(line, level);
        }catch{}
      }
      function apply(){
        try{
          var A = window.AFRAME;
          if (!A || !A.THREE) { post('INFO','A-Frame not ready for THREE shim'); return false; }
          if (!window.THREE) { window.THREE = A.THREE; post('INFO','window.THREE bound to AFRAME.THREE'); }

          var T = window.THREE;
          if (!T.Math) T.Math = {};
          var MU = T.MathUtils || (A.THREE && A.THREE.MathUtils);
          if (!T.Math.degToRad) T.Math.degToRad = MU && MU.degToRad ? MU.degToRad : function(d){ return d * Math.PI / 180; };
          if (!T.Math.radToDeg) T.Math.radToDeg = MU && MU.radToDeg ? MU.radToDeg : function(r){ return r * 180 / Math.PI; };
          if (!T.Math.clamp)    T.Math.clamp    = MU && MU.clamp    ? MU.clamp    : function(x,min,max){ return Math.min(Math.max(x,min),max); };
          if (!T.PlaneBufferGeometry && T.PlaneGeometry) T.PlaneBufferGeometry = T.PlaneGeometry;

          post('OK','THREE shim applied', { hasMath:!!T.Math, hasUtils:!!MU });
          return true;
        }catch(e){ post('ERR','THREE shim failed', {err:String(e)}); return false; }
      }
      if (!apply()){
        var tries = 0, id = setInterval(function(){ if (apply() || ++tries > 100) clearInterval(id); }, 50);
        document.addEventListener('DOMContentLoaded', apply, { once: true });
      }
      window.addEventListener('error', e => {
        if (e.message === 'Script error.' && !e.filename) { e.preventDefault(); return true; }
      });
      // lightweight client log panel bootstrap
      function pushLog(){/* stub until panel exists */} window.pushLog = pushLog;
    })();
  </script>

  <!-- AR.js (A-Frame build) -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.4/aframe/build/aframe-ar.js" crossorigin="anonymous"></script>

  <!-- Debug helpers and components -->
  <script>
    // Console overlay (last ~200 lines)
    (function initLogPanel(){
      const panel = document.createElement('div');
      panel.id = 'logpanel';
      panel.style.cssText = 'position:fixed;bottom:0;left:0;right:0;max-height:38vh;overflow:auto;background:rgba(0,0,0,.7);color:#eee;font:12px/16px ui-monospace,monospace;padding:6px 8px;z-index:999999;white-space:pre-wrap';
      document.addEventListener('DOMContentLoaded', ()=>document.body.appendChild(panel));
      const lines = [];
      window.pushLog = function(line, level='INFO'){
        try{
          const ts = new Date().toISOString().split('T')[1].replace('Z','');
          const el = document.createElement('div');
          el.textContent = `${ts} ${line}`;
          el.style.color = (level==='ERR'?'#ff6b6b': level==='WARN'?'#ffd166':'#eaeaea');
          lines.push(el);
          if (lines.length>200) lines.shift().remove();
          panel.appendChild(el); panel.scrollTop = panel.scrollHeight;
        }catch{}
      }
      window.addEventListener('error', e=>{
        const m = `[ERR] [window.onerror] ${e.message} @${e.filename||''}:${e.lineno||''}:${e.colno||''}`;
        console.log(m); window.ReactNativeWebView?.postMessage(JSON.stringify({type:'console', level:'error', args:[m]})); pushLog(m,'ERR');
      });
    })();

    // A-Frame minor helpers
    if (window.AFRAME) {
      // No-op rotation-reader if missing
      if (!AFRAME.components['rotation-reader']) {
        AFRAME.registerComponent('rotation-reader',{schema:{},tick:function(){}});
      }
      // Always-on-top & nocull
      AFRAME.registerComponent('always-on-top', {
        init(){ this._bump(); }, tick(){ this._bump(); },
        _bump(){ this.el.object3D.traverse(o=>{
          o.renderOrder = 9999;
          if (o.material){ o.material.depthTest=false; o.material.depthWrite=false; o.material.needsUpdate=true; }
          o.frustumCulled=false;
        });}
      });
      AFRAME.registerComponent('nocull', {tick(){ this.el.object3D.traverse(o=>{ o.frustumCulled=false; }); }});
    }
  </script>

  <style>
    html,body{margin:0;padding:0;overflow:hidden;background:#000;font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}
    .hud{
      position:fixed;top:8px;left:8px;right:8px;
      padding:8px 10px;background:rgba(0,0,0,.65);color:#fff;
      font-size:13px;line-height:18px;border-radius:12px;white-space:pre-line;
      z-index:999998; pointer-events:none;
    }
    .btnbar{
      position:fixed;top:8px;right:8px;display:flex;gap:6px;z-index:999999;
    }
    .btn{
      background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.3);
      padding:6px 8px;border-radius:8px;font:12px/14px ui-sans-serif;cursor:pointer;user-select:none
    }
  </style>
</head>
<body>
  <div id="hud" class="hud">Loading… allow camera & motion when prompted.</div>
  <div class="btnbar">
    <div class="btn" id="togglePanel">Hide Logs</div>
    <div class="btn" id="spawnLocal">Spawn Local Test Arrow</div>
  </div>

  <a-scene
    vr-mode-ui="enabled:false"
    renderer="alpha:true; antialias:true; physicallyCorrectLights:true; logarithmicDepthBuffer:true"
    embedded
    arjs="sourceType: webcam; videoTexture: true; trackingMethod: best; debugUIEnabled: false"
  >
    <!-- Lights for STANDARD materials -->
    <a-entity light="type: ambient; intensity: 1.25"></a-entity>
    <a-entity light="type: directional; intensity: 0.9" position="0 2 1"></a-entity>

    <!-- Use projected camera to match projected entities -->
    <a-camera gps-projected-camera rotation-reader camera="near:0.01; far:200000"></a-camera>

    <a-entity id="layer-arrows"></a-entity>
    <a-entity id="layer-arrival"></a-entity>

    <!-- Local sanity checks (should be visible immediately) -->
    <a-box id="local-cube" position="0 1.6 -2" depth="0.3" height="0.3" width="0.3"
           material="shader:standard; color:#22c55e; metalness:0; roughness:0.4; opacity:0.95; transparent:true"
           always-on-top nocull></a-box>

    <a-ring id="local-ring" position="0 0 -3" rotation="-90 0 0"
            radius-inner="0.4" radius-outer="0.55"
            material="shader:standard; color:#ffffff; metalness:0; roughness:0.5; opacity:0.95; transparent:true"
            always-on-top nocull></a-ring>
  </a-scene>

  <script>
  (function(){
    const W = (msg,obj)=>{ console.warn('[WARN]', msg, obj||''); pushLog(`[WARN] ${msg} ${obj?JSON.stringify(obj):''}`,'WARN'); };
    const L = (msg,obj)=>{ console.log('[INFO]', msg, obj||''); pushLog(`[INFO] ${msg} ${obj?JSON.stringify(obj):''}`); };
    const E = (msg,obj)=>{ console.error('[ERR]', msg, obj||''); pushLog(`[ERR] ${msg} ${obj?JSON.stringify(obj):''}`,'ERR'); };
    const SEND = (data)=>{ try{window.ReactNativeWebView?.postMessage(JSON.stringify(data));}catch{} };

    const hud = document.getElementById('hud');
    const arrowsLayer = document.getElementById('layer-arrows');
    const arrivalLayer = document.getElementById('layer-arrival');
    const cameraEl = document.querySelector('[gps-projected-camera]');

    // Buttons
    document.getElementById('togglePanel').addEventListener('click', ()=>{
      const p = document.getElementById('logpanel');
      if (!p) return; p.style.display = (p.style.display==='none'?'block':'none');
      document.getElementById('togglePanel').textContent = (p.style.display==='none'?'Show Logs':'Hide Logs');
    });
    document.getElementById('spawnLocal').addEventListener('click', ()=>{
      spawnLocalTestArrow();
    });

    // Presence checks
    const hasProjEnt = !!AFRAME?.components?.['gps-projected-entity-place'];
    const hasProjCam = !!AFRAME?.components?.['gps-projected-camera'];
    L('Components present', { gpsProjectedEntity:hasProjEnt, gpsProjectedCamera:hasProjCam });

    // Math helpers
    const toRad = d => d*Math.PI/180;
    function dMeters(a,b){
      const R=6371000, dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng), lat1=toRad(a.lat), lat2=toRad(b.lat);
      const hav = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
      return 2*R*Math.atan2(Math.sqrt(hav), Math.sqrt(1-hav));
    }

    // DOM helpers
    function clear(el){ if (!el) return; const n=el.children.length; while(el.firstChild) el.removeChild(el.firstChild); L('[DOM] cleared children', {id:el.id, removed:n}); }
    function placeAtLatLng(node, lat, lng){
      node.setAttribute('gps-projected-entity-place', `latitude: ${lat}; longitude: ${lng}`);
      L('[GPS] placeAtLatLng', {lat,lng});
    }
    function forceTop(el){
      el.setAttribute('always-on-top',''); el.setAttribute('nocull','');
      try{ el.object3D.traverse(o=>{ o.frustumCulled=false; o.renderOrder=9999; }); }catch{}
    }

    function scaleFor(distance){
      const s = Math.max(28, Math.min(64, 18 + (distance/2.5)));
      return `${s} ${s} ${s}`;
    }

    function makeArrow(yawDeg, approxDistance){
      const wrap = document.createElement('a-entity');
      wrap.setAttribute('rotation', `0 ${yawDeg||0} 0`);
      wrap.setAttribute('position', '0 2 0');
      wrap.setAttribute('scale', scaleFor(approxDistance || 30));
      forceTop(wrap);

      const shaft = document.createElement('a-cylinder');
      shaft.setAttribute('height','6.0');
      shaft.setAttribute('radius','0.35');
      shaft.setAttribute('position','0 3 0');
      shaft.setAttribute('material','shader:standard; color:#00E0FF; metalness:0; roughness:0.3; opacity:1; transparent:true');
      shaft.addEventListener('loaded', ()=> {
        const m = shaft.getObject3D('mesh')?.material; if (m){ m.depthTest=false; m.depthWrite=false; m.needsUpdate=true; }
        L('[MAT] shaft loaded + depth flags set');
      });

      const head = document.createElement('a-cone');
      head.setAttribute('height','2.6');
      head.setAttribute('radius-bottom','1.1');
      head.setAttribute('radius-top','0.01');
      head.setAttribute('position','0 5.5 0');
      head.setAttribute('material','shader:standard; color:#00E0FF; metalness:0; roughness:0.25; opacity:1; transparent:true');
      head.addEventListener('loaded', ()=> {
        const m = head.getObject3D('mesh')?.material; if (m){ m.depthTest=false; m.depthWrite=false; m.needsUpdate=true; }
        L('[MAT] head loaded + depth flags set');
      });

      wrap.appendChild(shaft);
      wrap.appendChild(head);
      L('[ARROW] created', {yawDeg, approxDistance});
      return wrap;
    }

    function makeDebugLabel(text, color){
      const e = document.createElement('a-entity');
      e.setAttribute('position','0 2.8 0');
      e.setAttribute('text',`value:${text}; color:${color||'#fff'}; align:center; width:8;`);
      e.setAttribute('look-at','[gps-projected-camera]');
      forceTop(e);
      return e;
    }

    // Local quick test: spawn a non-GPS arrow 3m ahead to prove 3D pipeline
    function spawnLocalTestArrow(){
      const root = document.createElement('a-entity');
      root.setAttribute('position','0 0 -3');
      root.setAttribute('rotation','0 0 0');
      forceTop(root);
      root.appendChild(makeDebugLabel('LOCAL', '#22c55e'));
      root.appendChild(makeArrow(0, 10));
      document.querySelector('a-scene').appendChild(root);
      L('[TEST] Spawned local test arrow at -3 Z (camera space)');
    }

    // State
    let anchors = [];       // [{lat,lng,yaw}]
    let activeIndex = 0;
    let arrived = false;
    let here = null;        // {lat,lng} from watchPosition
    let originReady = false;

    // HUD
    function updateHUD(dist){
      if (!anchors.length){ hud.textContent='Waiting for anchors…'; return; }
      if (arrived){ hud.textContent='Arrived — look around for the destination.'; return; }
      const next = anchors[activeIndex];
      const label = `${activeIndex+1}/${anchors.length}`;
      const dt = (typeof dist==='number') ? `${Math.max(0,Math.round(dist))} m` : '…';
      hud.textContent = `Next: ${label} — ${dt}${next?`\n(${next.lat.toFixed(5)}, ${next.lng.toFixed(5)})`:''}`;
      L('[HUD] updated', {activeIndex, total:anchors.length, dist:dt});
    }

    // Render
    function renderArrows(){
      L('[RENDER] begin', {activeIndex, total:anchors.length, originReady});
      clear(arrivalLayer); clear(arrowsLayer);
      if (!anchors.length || arrived){ L('[RENDER] aborted: no anchors or arrived'); return; }

      const toShow = [activeIndex, activeIndex+1].filter(i => i < anchors.length);
      L('[RENDER] will show', {count:toShow.length, indices:toShow});

      toShow.forEach((idx,i) => {
        const a = anchors[idx];
        const node = document.createElement('a-entity');
        placeAtLatLng(node, a.lat, a.lng);
        forceTop(node);

        node.appendChild(makeDebugLabel(i===0 ? 'NEXT' : '→', i===0 ? '#ff4444' : '#ffaa00'));

        const approx = here ? dMeters(here, a) : 30;
        node.appendChild(makeArrow(a.yaw, approx));
        arrowsLayer.appendChild(node);

        L('[RENDER] node appended', {idx, lat:a.lat, lng:a.lng, yaw:a.yaw, approx});
      });

      SEND({ type:'arrows_rendered', count: toShow.length, active: activeIndex });
      L('[RENDER] end', {children: arrowsLayer.children.length});
    }

    function showArrival(){
      arrived = true;
      clear(arrowsLayer); clear(arrivalLayer);
      const last = anchors[anchors.length-1]; if (!last) { W('[ARRIVAL] missing last anchor'); return; }

      const wrap = document.createElement('a-entity');
      placeAtLatLng(wrap, last.lat, last.lng);
      forceTop(wrap);

      const ring = document.createElement('a-ring');
      ring.setAttribute('radius-inner','2.0');
      ring.setAttribute('radius-outer','2.6');
      ring.setAttribute('rotation','-90 0 0');
      ring.setAttribute('position','0 0.2 0');
      ring.setAttribute('material','shader:standard; color:#10B981; metalness:0; roughness:0.5; opacity:1; transparent:true');
      wrap.appendChild(ring);

      const txt = makeDebugLabel('ARRIVED', '#10B981'); txt.setAttribute('position','0 2 0');
      wrap.appendChild(txt);

      arrivalLayer.appendChild(wrap);
      hud.textContent = 'Arrived — look around for the destination.';
      SEND({ type:'arrived' });
      L('[ARRIVAL] shown');
    }

    // Messaging from RN
    function setAnchors(data){
      anchors = Array.isArray(data) ? data : [];
      activeIndex = 0; arrived = false;
      L('[ANCHORS] received', {count:anchors.length, first:anchors[0]||null, last:anchors[anchors.length-1]||null});
      SEND({ type:'anchors_received', count: anchors.length });
      renderArrows(); updateHUD(undefined);
    }

    function onMsg(ev){
      try{
        const p = JSON.parse(ev.data);
        if (p?.type === 'anchors') setAnchors(p.data);
        else L('[MSG] unknown message', p);
      }catch(err){ E('[MSG] invalid', {err:String(err)}); }
    }
    document.addEventListener('message', onMsg);
    window.addEventListener('message', onMsg);

    // Geolocation
    function startWatch(){
      try{
        navigator.geolocation.getCurrentPosition(
          p => { L('[GPS] getCurrentPosition OK', {lat:p.coords.latitude, lng:p.coords.longitude, acc:p.coords.accuracy}); },
          e => { W('[GPS] getCurrentPosition ERR', {code:e.code, msg:e.message}); },
          { enableHighAccuracy:true, timeout:10000, maximumAge:1000 }
        );
        navigator.geolocation.watchPosition(
          pos => {
            here = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            SEND({ type:'geo_ok', lat: here.lat, lng: here.lng, acc: pos.coords.accuracy });
            L('[GPS] watch', {lat:here.lat, lng:here.lng, acc:pos.coords.accuracy, speed:pos.coords.speed, heading:pos.coords.heading});

            if (anchors.length && !arrived) {
              const target = anchors[activeIndex];
              const dist = dMeters(here, target);
              updateHUD(dist);

              // Keep current group scaled & on top
              try {
                const groups = arrowsLayer.children || [];
                for (let i=0;i<groups.length;i++){
                  const group = groups[i];
                  group.setAttribute('nocull','');
                  group.setAttribute('always-on-top','');
                  group.setAttribute('scale', scaleFor(dist));
                }
                L('[RENDER] rescaled groups', {groups:groups.length, dist});
              } catch(e){ W('[RENDER] rescale error', {err:String(e)}); }

              if (activeIndex < anchors.length-1 && dist <= 8){
                activeIndex += 1; L('[ADVANCE] next index', {activeIndex});
                renderArrows(); updateHUD(dMeters(here, anchors[activeIndex]));
                SEND({ type:'advance', idx: activeIndex });
              } else if (activeIndex === anchors.length-1 && dist <= 25 && !arrived){
                showArrival();
              }
            }
          },
          err => {
            W('[GPS] watchPosition ERR', {code:err?.code, msg:err?.message});
            SEND({ type:'geo_error', code:err?.code, message:err?.message });
          },
          { enableHighAccuracy:true, timeout:10000, maximumAge:1000, distanceFilter:1 }
        );
      }catch(e){ E('[GPS] startWatch failed', {err:String(e)}); }
    }

    // AR.js camera origin events (if fired by this build)
    ['gps-projected-camera-origin-coord','gps-camera-update-position'].forEach(evt=>{
      cameraEl && cameraEl.addEventListener(evt, (e) => {
        originReady = true;
        L('[ARJS] camera event', {evt, detail:e?.detail || null});
        renderArrows();
      });
    });

    window.addEventListener('load', function(){
      L('[BOOT] window load');
      SEND({ type:'ready' });
      startWatch();
      // If you see nothing, tap "Spawn Local Test Arrow" button (top-right)
    });
  })();
  </script>
</body>
</html>
